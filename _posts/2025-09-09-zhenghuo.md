---
layout: post
title: 智能家居与系统配置整活记录
date: 2025-09-09 22:44:00
forType: 日常整活
category: 智能家居
tag: [智能家居, HomeAssistant, 米家, Linux, 系统配置]
---

* content
{:toc}

## 一、智能家居整活项目

### 1.1 HomeAssistant引入NFC功能

随着智能家居的普及，NFC（近场通信）技术为自动化控制提供了更加便捷的方式。通过在HomeAssistant中集成NFC功能，我们可以实现"碰一碰"即可触发自动化场景的效果。

#### 1.1.1 准备工作

- HomeAssistant服务器（可以是树莓派或其他Linux设备）
- ACR122U或其他兼容的NFC读卡器
- 空白NFC标签（推荐使用NTAG213/215/216型号）

#### 1.1.2 安装必要组件

```bash
# 更新包管理器
sudo apt update && sudo apt upgrade -y

# 安装NFC相关库
sudo apt install libnfc5 libnfc-bin libusb-dev
sudo pip3 install ndeflib

# 配置NFC读卡器
sudo mkdir -p /etc/nfc/devices.d
sudo cp /usr/share/nfc/device.d/acr122u.conf.sample /etc/nfc/devices.d/acr122u.conf

# 测试NFC读卡器是否正常工作
nfc-list
```

#### 1.1.3 在HomeAssistant中配置NFC

1. 在HomeAssistant的`configuration.yaml`文件中添加以下配置：

```yaml
# 启用NFC集成
sensor:
  - platform: nfc
    on_tag: # 当检测到标签时触发的自动化
      - service: automation.trigger
        data:
          entity_id: automation.nfc_tag_scanned
```

2. 创建NFC自动化场景，例如在`automations.yaml`中添加：

```yaml
- alias: "NFC标签扫描"
  id: nfc_tag_scanned
  trigger:
    - platform: event
      event_type: nfc_scan
  action:
    - service: notify.mobile_app_your_phone
      data:
        message: "NFC标签已扫描！"
```

#### 1.1.4 写入NFC标签

使用`nfc-poll`命令检测NFC标签的UID，然后创建一个简单的自动化场景来识别特定标签：

```bash
# 检测NFC标签的UID
nfc-poll

# 或使用ndeftool写入自定义数据
ndeftool text "scene=living_room" | nfc-emulate
```

在HomeAssistant中创建基于标签UID的自动化：

```yaml
- alias: "客厅场景NFC标签"
  trigger:
    - platform: event
      event_type: nfc_scan
      event_data:
        tag_id: "YOUR_TAG_UID_HERE"
  action:
    - service: light.turn_on
      entity_id: light.living_room_lights
      data:
        brightness_pct: 70
        color_temp: 3000
    - service: media_player.turn_on
      entity_id: media_player.living_room_tv
```

### 1.2 米家引入NFC功能

米家生态系统也支持NFC功能，通过米家APP和支持NFC的手机，我们可以实现类似的便捷控制体验。

#### 1.2.1 米家NFC设置步骤

1. 打开米家APP，进入"我的"页面
2. 点击"设置" -> "NFC快捷功能"
3. 打开NFC快捷功能开关
4. 点击"添加场景"，选择要关联的智能设备或自动化场景
5. 将NFC标签贴近手机背面，等待写入完成
6. 写入成功后，可以自定义标签名称

#### 1.2.2 米家NFC标签应用场景

- **回家模式**：触碰标签打开空调、灯光、空气净化器等设备
- **离家模式**：触碰标签关闭所有设备，启动摄像头监控
- **观影模式**：触碰标签调暗灯光，打开电视和音响
- **睡眠模式**：触碰标签关闭主灯，开启小夜灯，拉上窗帘

### 1.3 米家中枢网关虚拟事件

米家中枢网关是米家生态系统的核心组件，通过创建虚拟事件，我们可以实现更加灵活的自动化控制。

#### 1.3.1 设置虚拟事件

1. 确保已安装最新版米家APP并添加了中枢网关
2. 进入中枢网关的设置页面
3. 找到"自动化" -> "条件" -> "手动执行"
4. 点击"添加"，创建一个新的虚拟事件
5. 为虚拟事件命名，如"触发客厅场景"

#### 1.3.2 虚拟事件使用方法

1. 在创建自动化时，可以将虚拟事件作为触发条件
2. 通过米家APP的"手动执行"功能，远程触发虚拟事件
3. 结合HomeAssistant，实现跨平台的自动化控制

### 1.4 HomeAssistant自动化集成虚拟事件

将HomeAssistant与米家中枢网关的虚拟事件集成，可以实现更加丰富的智能家居场景。

#### 1.4.1 安装HACS和小米网关集成

```bash
# 安装HACS（Home Assistant Community Store）
wget -O - https://get.hacs.xyz | bash -

# 重启HomeAssistant
sudo systemctl restart home-assistant@homeassistant
```

在HomeAssistant中配置小米网关集成：

1. 进入HomeAssistant的"配置" -> "集成" -> "添加集成"
2. 搜索"Xiaomi Gateway"并选择
3. 按照提示输入米家中枢网关的IP地址和密钥
4. 完成配置后，米家中枢网关的虚拟事件将显示在HomeAssistant中

#### 1.4.2 创建跨平台自动化

```yaml
- alias: "跨平台智能家居场景"
  trigger:
    - platform: event
      event_type: xiaomi_gateway_virtual_event
      event_data:
        event_id: "YOUR_VIRTUAL_EVENT_ID"
  action:
    - service: scene.turn_on
      entity_id: scene.complete_living_room_experience
    - service: notify.mobile_app_your_phone
      data:
        message: "客厅场景已启动！"
```

## 二、Linux系统配置整活

### 2.1 Linux配置Clash

Clash是一款功能强大的网络代理工具，支持多种协议，在Linux系统上配置Clash可以实现灵活的网络访问控制。

#### 2.1.1 下载并安装Clash

```bash
# 创建Clash目录
mkdir -p ~/.config/clash && cd ~/.config/clash

# 下载Clash二进制文件（根据系统架构选择）
wget -O clash.gz https://github.com/Dreamacro/clash/releases/download/v1.13.0/clash-linux-amd64-v1.13.0.gz

# 解压文件
gunzip clash.gz

# 添加执行权限
chmod +x clash

# 下载Country.mmdb文件
wget -O Country.mmdb https://github.com/Dreamacro/maxmind-geoip/releases/download/20231013/Country.mmdb
```

#### 2.1.2 配置Clash

1. 将您的Clash配置文件（通常是`config.yaml`或`config.yml`）放入`~/.config/clash/`目录
2. 编辑配置文件，确保以下关键配置正确：

```yaml
# 基本配置示例
port: 7890
socks-port: 7891
redir-port: 7892
allow-lan: true
bind-address: '*'
mode: Rule
log-level: info
# ...其他配置
```

3. 创建Clash系统服务：

```bash
sudo vim /etc/systemd/system/clash.service
```

添加以下内容：

```ini
[Unit]
Description=Clash - A rule-based proxy in Go
After=network.target

[Service]
Type=simple
User=YOUR_USERNAME
ExecStart=/home/YOUR_USERNAME/.config/clash/clash -d /home/YOUR_USERNAME/.config/clash
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

注意：将`YOUR_USERNAME`替换为您的实际用户名

4. 启动并启用Clash服务：

```bash
sudo systemctl daemon-reload
sudo systemctl start clash
sudo systemctl enable clash

# 检查Clash服务状态
sudo systemctl status clash
```

#### 2.1.3 设置系统代理

在`~/.bashrc`或`~/.zshrc`文件末尾添加以下内容：

```bash
# Clash代理设置
export http_proxy="http://127.0.0.1:7890"
export https_proxy="http://127.0.0.1:7890"
export all_proxy="socks5://127.0.0.1:7891"

# 取消代理的函数
unproxy() {
unset http_proxy\ununset https_proxy\ununset all_proxy
}
```

使配置生效：

```bash
source ~/.bashrc  # 或 ~/.zshrc
```

#### 2.1.4 使用Clash Web界面

Clash提供了Web界面，方便管理代理规则和节点：

1. 确保配置文件中启用了外部控制器：

```yaml
# 在config.yaml中添加
external-controller: 127.0.0.1:9090
secret: "YOUR_SECRET_HERE"  # 可选，设置访问密码
```

2. 重启Clash服务：

```bash
sudo systemctl restart clash
```

3. 通过浏览器访问Clash Dashboard（可以使用官方Dashboard或第三方Dashboard如yacd）

官方Dashboard：
```
http://clash.razord.top/
```

yacd Dashboard：
```
http://yacd.haishan.me/
```

在Dashboard中，设置API地址为`http://127.0.0.1:9090`，如果设置了secret，则需要输入密码。

## 三、实用工具与扩展

### 3.1 智能家居自动化脚本示例

以下是一个结合NFC、HomeAssistant和米家的自动化脚本示例：

```python
#!/usr/bin/env python3
"""智能家居自动化控制脚本"""

import requests
import time
from pynfc import Nfc

# HomeAssistant配置
HASS_URL = "http://YOUR_HASS_IP:8123/api/services"
HASS_TOKEN = "YOUR_LONG_LIVED_TOKEN"

# 米家配置（通过米家开放平台API）
MIJIA_APP_KEY = "YOUR_APP_KEY"
MIJIA_APP_SECRET = "YOUR_APP_SECRET"

# NFC标签ID与场景映射
tag_scenes = {
    "TAG_UID_1": "home_scene",
    "TAG_UID_2": "away_scene",
    "TAG_UID_3": "movie_scene",
    "TAG_UID_4": "sleep_scene"
}

def trigger_homeassistant_scene(scene_id):
    """触发HomeAssistant场景"""
    headers = {
        "Authorization": f"Bearer {HASS_TOKEN}",
        "Content-Type": "application/json"
    }
    data = {
        "entity_id": f"scene.{scene_id}"
    }
    response = requests.post(f"{HASS_URL}/scene/turn_on", headers=headers, json=data)
    return response.status_code == 200

def process_nfc_tag(tag_uid):
    """处理NFC标签读取事件"""
    if tag_uid in tag_scenes:
        scene = tag_scenes[tag_uid]
        success = trigger_homeassistant_scene(scene)
        if success:
            print(f"成功触发场景：{scene}")
        else:
            print(f"触发场景失败：{scene}")
    else:
        print(f"未识别的NFC标签：{tag_uid}")

def main():
    """主函数"""
    print("智能家居NFC控制系统已启动...")
    try:
        nfc = Nfc()
        while True:
            tag = nfc.poll()
            if tag:
                tag_uid = tag.uid.hex().upper()
                print(f"读取到NFC标签：{tag_uid}")
                process_nfc_tag(tag_uid)
            time.sleep(1)
    except KeyboardInterrupt:
        print("程序已退出")
    except Exception as e:
        print(f"发生错误：{e}")

if __name__ == "__main__":
    main()
```

使用前需要安装必要的Python库：

```bash
pip install requests pynfc
```

## 四、总结与展望

通过以上整活项目，我们实现了：

1. **NFC便捷控制**：通过HomeAssistant和米家系统集成NFC功能，实现"碰一碰"控制智能家居
2. **虚拟事件联动**：利用米家中枢网关的虚拟事件，实现跨平台的自动化控制
3. **Linux系统优化**：配置Clash实现灵活的网络代理，提升系统使用体验

未来，我们可以进一步探索：

- 集成更多物联网设备，扩展智能家居生态
- 开发自定义的HomeAssistant组件和米家插件
- 利用机器学习技术，实现更加智能的场景推荐和自动化控制
- 探索边缘计算在智能家居中的应用，提高响应速度和隐私保护

希望本记录能为您的智能家居和系统配置整活提供一些参考和灵感！
