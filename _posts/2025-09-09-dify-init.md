---
layout: post
title: Dify本地部署完全指南
date: 2025-09-09 17:38:00
forType: AI
category: dify
tag: [AI, AGENT, 工作流, 本地部署]
---

* content
{:toc}

## Dify简介

Dify是一个开源的LLM应用开发平台，提供完整的模型微调、推理、知识库构建和工作流编排能力，让开发者可以快速构建和部署AI应用。其主要特点包括：

- **可视化开发界面**：无需复杂编码，通过拖拽即可构建AI应用
- **丰富的模型支持**：兼容主流开源和商业大语言模型
- **知识库管理**：支持多种文档格式的导入和向量化存储
- **工作流编排**：提供图形化工具设计复杂的AI工作流
- **API集成**：一键生成可调用的API接口
- **协作功能**：支持多用户协作开发和管理

## Docker Compose 部署

## 克隆 Dify 代码仓库
克隆 Dify 源代码至本地环境。建议使用最新的稳定版本分支。
```bash
# 克隆主分支（获取最新开发版）
git clone https://github.com/langgenius/dify.git

# 或克隆指定稳定版本（推荐）
# 查看最新稳定版本：https://github.com/langgenius/dify/releases
git clone https://github.com/langgenius/dify.git --branch v0.6.13 # 替换为最新版本号

## 启动 Dify

1. 进入 Dify 源代码的 Docker 目录
   ```bash
   cd dify/docker
   ```

2. 复制环境配置文件并根据需要进行修改
   ```bash
   # 复制配置文件
   cp .env.example .env
   
   # 可选：使用编辑器修改配置
   # vim .env 或 nano .env
   ```

3. 配置文件主要参数说明：
   - `OPENAI_API_KEY`: OpenAI API密钥（如使用OpenAI模型）
   - `WEAVIATE_URL`: Weaviate向量数据库地址
   - `POSTGRES_URL`: PostgreSQL数据库连接信息
   - `REDIS_URL`: Redis缓存连接信息
   - `CONSOLE_API_KEY`: 控制台API密钥
   - `LOG_LEVEL`: 日志级别
4. 启动 Docker 容器
   首先检查你的 Docker Compose 版本：
   ```bash
   docker compose version  # Docker Compose V2
   # 或
   docker-compose version  # Docker Compose V1
   ```
   
   根据版本选择合适的命令启动容器：
   
   - **Docker Compose V2**：
     ```bash
     docker compose up -d
     ```
     
   - **Docker Compose V1**：
     ```bash
     docker-compose up -d
     ```
     
   首次启动时，系统会下载所有必要的镜像，这可能需要一些时间，具体取决于你的网络速度。
## 检查容器状态

运行命令后，你应该会看到类似以下的输出，显示所有容器的状态和端口映射：

```bash
[+] Running 11/11
 ✔ Network docker_ssrf_proxy_network  Created                                                                 0.1s 
 ✔ Network docker_default             Created                                                                 0.0s 
 ✔ Container docker-redis-1           Started                                                                 2.4s 
 ✔ Container docker-ssrf_proxy-1      Started                                                                 2.8s 
 ✔ Container docker-sandbox-1         Started                                                                 2.7s 
 ✔ Container docker-web-1             Started                                                                 2.7s 
 ✔ Container docker-weaviate-1        Started                                                                 2.4s 
 ✔ Container docker-db-1              Started                                                                 2.7s 
 ✔ Container docker-api-1             Started                                                                 6.5s 
 ✔ Container docker-worker-1          Started                                                                 6.4s 
 ✔ Container docker-nginx-1           Started                                                                 7.1s
```

启动完成后，可以使用以下命令检查所有容器是否正常运行：

```bash
# 查看所有容器状态
docker compose ps

# 查看实时日志
docker compose logs -f

# 查看特定服务的日志
docker compose logs -f api web worker
```

在容器状态输出中，你应该可以看到包括：
- 3 个业务服务：api、worker、web
- 6 个基础组件：weaviate、db、redis、nginx、ssrf_proxy、sandbox

所有容器的状态都应该显示为"Up"或"Up (healthy)"，表明服务正常运行。

### 容器状态示例
容器状态输出示例（使用`docker compose ps`命令）：

```bash
NAME                  IMAGE                              COMMAND                   SERVICE      CREATED              STATUS                        PORTS
docker-api-1          langgenius/dify-api:0.6.13         "/bin/bash /entrypoi…"   api          About a minute ago   Up About a minute             5001/tcp
docker-db-1           postgres:15-alpine                 "docker-entrypoint.s…"   db           About a minute ago   Up About a minute (healthy)   5432/tcp
docker-nginx-1        nginx:latest                       "sh -c 'cp /docker-e…"   nginx        About a minute ago   Up About a minute             0.0.0.0:80->80/tcp, :::80->80/tcp, 0.0.0.0:443->443/tcp, :::443->443/tcp
docker-redis-1        redis:6-alpine                     "docker-entrypoint.s…"   redis        About a minute ago   Up About a minute (healthy)   6379/tcp
docker-sandbox-1      langgenius/dify-sandbox:0.2.1      "/main"                   sandbox      About a minute ago   Up About a minute             
docker-ssrf_proxy-1   ubuntu/squid:latest                "sh -c 'cp /docker-e…"   ssrf_proxy   About a minute ago   Up About a minute             3128/tcp
docker-weaviate-1     semitechnologies/weaviate:1.19.0   "/bin/weaviate --hos…"   weaviate     About a minute ago   Up About a minute             
docker-web-1          langgenius/dify-web:0.6.13         "/bin/sh ./entrypoin…"   web          About a minute ago   Up About a minute             3000/tcp
docker-worker-1       langgenius/dify-api:0.6.13         "/bin/bash /entrypoi…"   worker       About a minute ago   Up About a minute             5001/tcp
```

通过以上步骤，你可以在本地成功安装并运行 Dify 平台。

## 更新 Dify

当 Dify 发布新版本时，你可以按照以下步骤进行更新：

1. 首先进入 Dify 源代码的 docker 目录
   ```bash
   cd dify/docker
   ```

2. 停止当前运行的 Dify 服务
   ```bash
   docker compose down
   ```

3. 拉取最新的代码（或指定版本的代码）
   ```bash
   # 拉取最新的主分支代码
   git pull origin main
   
   # 或切换到特定版本（推荐）
   # git checkout v0.6.14  # 替换为最新版本号
   ```

4. 拉取最新的 Docker 镜像
   ```bash
   docker compose pull
   ```

5. 重新启动 Dify 服务
   ```bash
   docker compose up -d
   ```

### 同步环境变量配置 (重要！)

每次更新后，请务必执行以下操作：

1. 比较 `.env.example` 和你本地的 `.env` 文件，查看是否有新增或修改的配置项
   ```bash
   # 使用 diff 命令查看差异
   diff .env.example .env
   ```

2. 根据需要，将 `.env.example` 中的新变量添加到 `.env` 文件中，并更新已更改的任何值

3. 确保所有配置项都与你的实际运行环境相匹配，特别是数据库连接信息、API密钥等敏感信息

4. 重新启动 Dify 服务以使新配置生效
   ```bash
   docker compose down
   docker compose up -d
   ```

**提示**：在进行重大版本更新前，建议先备份你的数据库，以防数据丢失。

## 访问 Dify

### 首次访问设置

成功启动 Dify 后，你需要先设置管理员账户才能开始使用：

1. **访问管理员初始化页面**：
   - **本地环境**：打开浏览器，访问 [http://localhost/install](http://localhost/install)
   - **服务器环境**：访问 [http://your_server_ip/install](http://your_server_ip/install)（将 `your_server_ip` 替换为你的服务器实际 IP 地址）

2. **创建管理员账户**：
   - 设置一个安全的用户名和密码
   - 填写必要的个人信息
   - 点击"完成安装"按钮

3. **登录 Dify 平台**：
   - **本地环境**：访问 [http://localhost](http://localhost)
   - **服务器环境**：访问 [http://your_server_ip](http://your_server_ip)
   - 使用刚刚创建的管理员账户登录

### 平台功能访问

登录后，你可以访问 Dify 的各项核心功能：

- **应用构建**：创建和管理 AI 应用程序
- **知识库**：上传文档并构建向量知识库
- **工作流**：设计和编排复杂的 AI 工作流
- **API 配置**：生成和管理应用的 API 密钥
- **系统设置**：管理用户、团队和平台配置

### 端口说明

默认情况下，Dify 通过以下端口提供服务：
- **Web 界面**：80（HTTP）和 443（HTTPS，需要配置 SSL 证书）
- **API 服务**：5001（内部容器端口）

如果需要修改默认端口，可以编辑 `docker/docker-compose.yml` 文件中的端口映射配置。

## 自定义配置

Dify 提供了丰富的环境变量配置选项，让你可以根据自己的需求定制平台行为。以下是自定义配置的步骤：

### 基本配置步骤

1. 编辑 `.env` 文件修改环境变量值
   ```bash
   # 使用你喜欢的编辑器打开配置文件
   vim .env
   # 或
   nano .env
   ```

2. 修改完成后，重新启动 Dify 服务以使配置生效
   ```bash
   docker compose down
   docker compose up -d
   ```

### 常用配置项说明

以下是一些常用的环境变量配置项及其说明：

#### 基础设置
- `LOG_LEVEL`：日志级别（可选值：DEBUG, INFO, WARNING, ERROR）
- `TIME_ZONE`：时区设置（例如：Asia/Shanghai）
- `LANGUAGE`：界面语言（可选值：zh-CN, en-US）

#### 数据库配置
- `POSTGRES_URL`：PostgreSQL 数据库连接地址
- `REDIS_URL`：Redis 缓存连接地址
- `WEAVIATE_URL`：Weaviate 向量数据库连接地址

#### 安全配置
- `CONSOLE_API_KEY`：控制台 API 密钥
- `SECRET_KEY`：用于加密的密钥
- `JWT_SECRET`：JWT 令牌签名密钥

#### 外部服务配置
- `OPENAI_API_KEY`：OpenAI API 密钥
- `ANTHROPIC_API_KEY`：Anthropic API 密钥
- `GOOGLE_API_KEY`：Google API 密钥

#### 存储配置
- `STORAGE_TYPE`：存储类型（可选值：local, s3）
- `LOCAL_STORAGE_PATH`：本地存储路径
- `AWS_S3_BUCKET`：S3 存储桶名称（当使用 S3 存储时）

### 高级配置示例

#### 配置自定义域名

要为 Dify 设置自定义域名，需要修改 Nginx 配置：

1. 编辑 `docker/nginx/conf.d/default.conf` 文件
2. 添加或修改 server_name 指令，指向你的自定义域名
3. 配置 SSL 证书路径（如果需要 HTTPS）
4. 保存并重启 Dify 服务

#### 配置邮件服务

设置邮件服务用于用户注册、密码重置等功能：

```bash
# 在 .env 文件中添加以下配置
MAIL_SERVER=smtp.your-email-provider.com
MAIL_PORT=587
MAIL_USERNAME=your-email@example.com
MAIL_PASSWORD=your-email-password
MAIL_USE_TLS=true
MAIL_USE_SSL=false
MAIL_FROM=your-email@example.com
```

完整的环境变量列表可以在 `docker/.env.example` 文件中找到，建议在修改任何配置之前先查看该文件。

# 使用源代码本地启动

除了使用 Docker Compose 部署外，Dify 也支持通过源代码直接在本地启动，这对于开发者进行定制开发和调试非常有用。以下是使用源代码本地启动的步骤：

## 前置要求

在开始之前，请确保你的系统上已经安装了以下软件：

- **Node.js**：版本 16.x 或更高
- **Python**：版本 3.9 或更高
- **PostgreSQL**：版本 14 或更高
- **Redis**：版本 6 或更高
- **Weaviate**：版本 1.19.0 或更高

## 安装步骤

### 1. 克隆代码仓库

```bash
git clone https://github.com/langgenius/dify.git
cd dify
```

### 2. 配置基础服务

在本地启动 Dify 之前，需要先确保 PostgreSQL、Redis 和 Weaviate 服务已经启动并配置正确。

#### PostgreSQL 配置

创建 Dify 所需的数据库和用户：

```bash
# 登录 PostgreSQL
sudo -u postgres psql

# 创建数据库和用户
CREATE DATABASE dify;
CREATE USER dify_user WITH ENCRYPTED PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE dify TO dify_user;
\q
```

#### Redis 配置

确保 Redis 服务正在运行，默认配置通常就可以满足需求。

#### Weaviate 配置

使用 Docker 启动 Weaviate 服务：

```bash
docker run -p 8080:8080 semitechnologies/weaviate:1.19.0
```

### 3. 配置后端服务

进入后端目录并安装依赖：

```bash
cd api
pip install -r requirements.txt
```

创建 `.env` 文件并配置必要的环境变量：

```bash
# 复制示例配置文件
cp .env.example .env

# 编辑 .env 文件，配置数据库连接和其他必要设置
vim .env
```

关键配置项：
- `DATABASE_URL`：PostgreSQL 数据库连接字符串
- `REDIS_URL`：Redis 连接字符串
- `WEAVIATE_URL`：Weaviate 服务地址

### 4. 配置前端服务

进入前端目录并安装依赖：

```bash
cd ../web
npm install
```

创建 `.env.local` 文件并配置必要的环境变量：

```bash
# 复制示例配置文件
cp .env.example .env.local

# 编辑 .env.local 文件
vim .env.local
```

关键配置项：
- `VITE_API_URL`：后端 API 地址（通常为 http://localhost:5001）

### 5. 启动服务

#### 启动后端服务

```bash
cd ../api
python main.py
```

后端服务默认将在 http://localhost:5001 上运行。

#### 启动前端服务

在另一个终端中运行：

```bash
cd ../web
npm run dev
```

前端服务默认将在 http://localhost:3000 上运行。

#### 启动工作器服务

在第三个终端中运行：

```bash
cd ../api
python worker.py
```

## 开发注意事项

1. **数据库迁移**：当后端代码有数据库结构变更时，需要运行迁移脚本：
   ```bash
   cd api
   alembic upgrade head
   ```

2. **代码风格**：Dify 使用 pre-commit 钩子来确保代码风格一致性，建议在提交代码前运行：
   ```bash
   pre-commit install
   pre-commit run --all-files
   ```

3. **日志调试**：如需更详细的日志信息，可以在 `.env` 文件中设置 `LOG_LEVEL=DEBUG`

4. **测试**：运行测试套件确保代码更改不会破坏现有功能：
   ```bash
   cd api
   pytest
   ```

## 引用

本文档参考了 Dify 官方文档：[dify部署社区版](https://docs.dify.ai/zh-hans/getting-started/install-self-hosted/readme)

更多详细信息，请访问 [Dify GitHub 仓库](https://github.com/langgenius/dify) 或 [官方文档](https://docs.dify.ai/)。